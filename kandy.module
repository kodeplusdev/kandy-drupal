<?php
/**
 * @file
 * Kandy module for drupal.
 */

define('KANDY_API_BASE_URL', 'https://api.kandy.io/v1.2/');
define('KANDY_JS_URL', 'https://kandy-portal.s3.amazonaws.com/public/javascript/kandy/2.5.0/kandy.js');
define('KANDY_JQUERY', 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js');
define('KANDY_FONT_AWESOME', 'http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css');
define('KANDY_SELECT2_PATH', 'https://cdnjs.cloudflare.com/ajax/libs/select2/3.5.2/');
define('KANDY_JQUERY_RELOAD', FALSE);
define('KANDY_SSL_VERIFY', FALSE);
define('KANDY_USER_TABLE', 'kandy_users');
define('KANDY_API_KEY', '');
define('KANDY_DOMAIN_SECRET_KEY', '');
define('KANDY_DOMAIN_NAME', '');
define('KANDY_VIDEO_WRAPPER_CLASS_DEFAULT', 'kandyVideoWrapper');
define('KANDY_VIDEO_STYLE_DEFAULT', 'width: 340px; height: 250px;background-color: darkslategray;');
define('KANDY_VIDEO_MY_TITLE_DEFAULT', 'me');
define('KANDY_VIDEO_THEIR_TITLE_DEFAULT', 'their');
define('KANDY_UN_ASSIGN_USER', 'kandy-un-assign-user');
define('KANDY_PSTN_TYPE', 'PSTN');
define('KANDY_MODULE_URL', '/' . drupal_get_path('module', 'kandy'));
define('KANDY_LIVECHAT_JS', KANDY_MODULE_URL . '/js/kandylivechat.js');
define('KANDY_LIVECHAT_CSS', drupal_get_path('module', 'kandy') . '/css/kandylivechat.css');
define('KANDY_USER_TYPE_AGENT', 1);
define('KANDY_USER_TYPE_NORMAL', 0);
define('KANDY_USER_TYPE_END_USER', 2);
define('KANDY_USER_STATUS_ONLINE', 1);
define('KANDY_USER_STATUS_OFFLINE', 0);
/**
 * Implements hook_help().
 */
function kandy_help($path, $arg) {
  switch ($path) {
    case 'admin/help#kandy':
      $module_path = drupal_get_path('module', 'kandy');
      $output = file_get_contents($module_path . '/includes/help.html');
      return $output;
  }
}

/**
 * Implements hook_menu().
 */
function kandy_menu() {
  $items = array();
  $items['admin/config/content/kandy'] = array(
    'title' => 'Kandy',
    'description' => 'Configuration for Kandy module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandy_form'),
    'access arguments' => array('administer site configuration'),
    'weight' => 4,
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/config/content/kandy/script'] = array(
    'title' => 'Kandy Script Customization',
    'page callback' => 'kandy_script_customization_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/content/kandy/style'] = array(
    'title' => 'Kandy Style Customization',
    'page callback' => 'kandy_style_customization_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/content/kandy/assignment'] = array(
    'title' => 'Kandy User Assignment',
    'page callback' => 'kandy_assignment_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/content/kandy/assignment/edit/%user'] = array(
    'title' => 'Kandy User Assignment',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandy_assignment_edit_form', 6),
    'type' => MENU_CALLBACK,
    'weight' => 2,
    'access arguments' => array('administer site configuration'),
    'file' => 'kandy.module',
  );

  $items['admin/config/content/kandy/assignment/sync'] = array(
    'title' => 'Kandy User synchronization',
    'page callback' => 'kandy_assignment_sync_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,

  );

  $items['admin/config/content/kandy/file/edit/%/%'] = array(
    'title' => 'Kandy File Edit   ',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandy_file_edit_form', 6, 7),
    'access arguments' => array('administer site configuration'),
    'weight' => 3,
    'type' => MENU_CALLBACK,
    'file' => 'kandy.module',
  );

  $items['kandy/get_user_for_search'] = array(
    'title' => 'Get User Name by kandy user id',
    'page callback' => 'kandy_get_user_for_search',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/get_name_for_contact'] = array(
    'title' => 'Get user name for chat',
    'page callback' => 'kandy_get_name_for_contact_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/get_name_for_chat_content'] = array(
    'title' => 'Get user name for chat',
    'page callback' => 'kandy_get_name_for_chat_content_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/get_un_assign_user'] = array(
    'title' => 'Get Un_assign user',
    'page callback' => 'kandy_get_un_assign_user_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['admin/config/content/kandy/livechat/agent'] = array(
    'title' => 'Live Chat Agent',
    'page callback' => 'kandy_chat_agent_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/content/kandy/livechat/viewAgent/%'] = array(
    'title' => 'Agent',
    'page callback' => 'kandy_view_agent_page',
    'page arguments' => array(6),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );

  $items['admin/config/content/kandy/livechat/addAgent'] = array(
    'title' => 'Add new chat Agent',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandy_agent_form'),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administer site configuration'),
    'file' => 'kandy.module',
  );

  $items['admin/config/content/kandy/livechat/addUser'] = array(
    'title' => 'Live Chat User',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandy_user_form'),
    'type' => MENU_LOCAL_TASK,
    'access arguments' => array('administer site configuration'),
    'file' => 'kandy.module',
  );

  $items['admin/config/content/kandy/livechat/removeAgent/%'] = array(
    'title' => 'Remove chat agent',
    'page callback' => 'kandy_remove_agent',
    'page arguments' => array(6),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );

  $items['admin/config/content/kandy/livechat/user'] = array(
    'title' => 'Chat user assignment page',
    'page callback' => 'kandy_chat_user_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/kandy_register_guest'] = array(
    'title' => 'Register customer for live chat',
    'page callback' => 'kandy_register_guest_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/kandy_get_free_user'] = array(
    'title' => 'Get a pair of kandy users for live chat',
    'page callback' => 'kandy_get_free_user_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/kandy_end_chat_session'] = array(
    'title' => 'End chat session',
    'page callback' => 'kandy_end_chat_session_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['kandy/kandy_still_alive'] = array(
    'page callback' => 'kandy_update_login_status_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/kandy_rate_agent'] = array(
    'title' => 'Rate for agent',
    'page callback' => 'kandy_rate_agent_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['kandy/set_presence/%'] = array(
    'page callback' => 'kandy_set_presence_status_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'page arguments' => array(2),
  );

  $items['kandy/get_presence'] = array(
    'page callback' => 'kandy_get_presence_status_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * KANDY ASSIGNMENT CONFIGURATION PAGE.
 *
 * @return array
 *   Render Assign Page.
 */
function kandy_assignment_page() {
  module_load_include('php', 'kandy', 'kandy_api');
  // We are going to output the results in a table with a nice header.
  $header = array(
    array('data' => t('UID')),
    array('data' => t('Name')),
    array('data' => t('Kandy user')),
    array('data' => t('Actions')),
  );

  $rows = kandy_get_user_data();

  $build['sync'] = array(
    '#type' => 'link',
    '#title' => t('Sync kandy user'),
    '#href' => url(
      'admin/config/content/kandy/assignment/sync',
      array(
        'query' => array(
          'returnPath' => 'admin/config/content/kandy/assignment',
        ),
        'absolute' => TRUE,
      )
    ),
  );
  // Create a render array which will be themed as a table with a pager.
  $build['pager_table'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('There are no user found in the db'),
  );

  // Attach the pager theme.
  $build['pager_pager'] = array('#theme' => 'pager');
  return $build;
}

/**
 * Sync KANDY USER.
 *
 * @return string
 *   Render Sync user page.
 */
function kandy_assignment_sync_page() {
  module_load_include('php', 'kandy', 'kandy_api');
  $return_path = url('admin/config/content/kandy/assignment', array('absolute' => TRUE));
  if (isset($_GET['returnPath']) && drupal_valid_path($_GET['returnPath']) && isset($_GET['id'])) {
    $return_path = url($_GET['returnPath'], array(
      'query' => array('id' => $_GET['id']),
      'absolute' => TRUE,
    ));
  }
  else {
    if (isset($_GET['returnPath']) && drupal_valid_path($_GET['returnPath'])) {
      $return_path = url($_GET['returnPath'], array('absolute' => TRUE));
    }
  }
  $result = kandy_sync_users();
  if ($result['success']) {
    drupal_set_message(t('Save successfully'));
    drupal_goto($return_path);
  }
  else {
    drupal_set_message(t('Sync Fail'), 'error');
    drupal_set_message(l(t('See log'), url('admin/reports/dblog', array('absolute' => TRUE))));
    return l(t('Try Again'), url('admin/config/content/kandy/assignment/sync', array('absolute' => TRUE)));
  }
}

/**
 * Kandy User Assignment Form.
 *
 * @return array
 *   Render edit user form.
 */
function kandy_assignment_edit_form($form, $form_state, $account) {
  module_load_include('php', 'kandy', 'kandy_api');
  $form = array();
  if ($account) {
    $kandy_user = kandy_get_assign_user($account->uid);
    $active_select_kandy_user = $kandy_user ? $kandy_user->user_id : NULL;

    $kandy_users_unassigned = kandy_list_users(KANDY_USER_UNASSIGNED);
    $select_data[''] = t('None');
    if ($active_select_kandy_user) {
      $select_data[$active_select_kandy_user] = $active_select_kandy_user;
    }
    foreach ($kandy_users_unassigned as $kandy_user_item) {
      $select_data[$kandy_user_item->user_id] = $kandy_user_item->user_id;
    }

    if (variable_get('kandy_jquery_reload', 1)) {
      drupal_add_js(KANDY_JQUERY);
    }

    drupal_add_css(KANDY_SELECT2_PATH . 'select2.min.css', array(
      'group' => 'kandy',
      'weight' => 2,
      'type' => 'external',
    ));
    drupal_add_js(KANDY_SELECT2_PATH . 'select2.min.js', array(
      'group' => 'kandy',
      'weight' => 2,
    ));

    drupal_add_js(
      'jQuery(document).ready(function ($) {
          $("#kandy-user-select2").select2();
       });',
      'inline'
    );

    $form['sync'] = array(
      '#type' => 'link',
      '#title' => t('Sync kandy user'),
      '#href' => url(
        'admin/config/content/kandy/assignment/sync',
        array(
          'query' => array(
            'returnPath' => 'admin/config/content/kandy/assignment/edit',
            'id' => $account->uid,

          ),
          'absolute' => TRUE,
        )
      ),
    );

    $form['username'] = array(
      '#markup' => '<p>' . t('Username: @accountName', array('@accountName' => $account->name)) . '</p>',
    );

    $form['user_id'] = array(
      '#type' => 'select',
      '#title' => t('Kandy User'),
      '#options' => $select_data,
      '#default_value' => $active_select_kandy_user,
      '#description' => t('Set this to <em>None</em> if you would like to unassign this user.'),
      '#attributes' => array(
        'id' => 'kandy-user-select2',
        'style' => 'width: 400px',
      ),
    );

    $form['main_user_id'] = array('#type' => 'hidden', '#value' => $account->uid);

    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save'),
    );

    $return_url = url(
      'admin/config/content/kandy/assignment',
      array('absolute' => TRUE));
    $form['back'] = array(
      '#markup' => '<a href="' . $return_url . '"><input class="form-submit" type="button" value="' . t('Back') . '"/></a>',
    );

    return $form;
  }
  else {
    drupal_goto('admin/config/content/kandy');
  }

}

/**
 * Kandy User Form Submit Action.
 *
 * @param object $form
 *   Form.
 * @param string $form_state
 *   Form state.
 */
function kandy_assignment_edit_form_submit($form, &$form_state) {
  module_load_include('php', 'kandy', 'kandy_api');
  if (isset($form_state['values']['main_user_id'])) {
    $main_user_id = intval($form_state['values']['main_user_id']);
    $user_id = check_plain($form_state['values']['user_id']);

    if (empty($user_id)) {
      kandy_unassign_user($main_user_id);
    }
    else {
      kandy_assign_user($user_id, $main_user_id);
    }
  }

  $form_state['redirect'] = 'admin/config/content/kandy/assignment';
}

/**
 * Kandy Configuration Form.
 *
 * @param object $form
 *   Form Object.
 * @param string $form_state
 *   Form State.
 *
 * @return mixed
 *   Form.
 */
function kandy_form($form, &$form_state) {
  $form['kandy_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Api key'),
    '#default_value' => variable_get('kandy_api_key', ''),
    '#size' => 100,
    '#maxlength' => 255,
    '#description' => t('The api key to connect to server.'),
    '#required' => TRUE,
  );
  $form['kandy_domain_secret_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Domain secret key'),
    '#default_value' => variable_get('kandy_domain_secret_key', ''),
    '#size' => 100,
    '#maxlength' => 255,
    '#description' => t('The domain secret key to get data from server.'),
    '#required' => TRUE,
  );

  $form['kandy_domain_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Domain name'),
    '#default_value' => variable_get('kandy_domain_name', KANDY_DOMAIN_NAME),
    '#size' => 100,
    '#maxlength' => 255,
    '#description' => t('The domain name of kandy user to get data.'),
    '#required' => FALSE,
  );

  $form['kandy_jquery_reload'] = array(
    '#type' => 'select',
    '#title' => t('Jquery Reload'),
    '#options' => array(0 => t('No'), 1 => t('Yes')),
    '#default_value' => variable_get('kandy_jquery_reload', 1),
    '#description' => t(
      'Set this to <em>No</em> if you have loaded jquery.'
    ),
  );

  $form['kandy_excluded_users'] = array(
    '#type' => 'textfield',
    '#title' => 'Kandy Excluded Users',
    '#size' => 100,
    '#maxlength' => 255,
    '#description' => t('List of reserved users, these users cannot be assigned'),
    '#default_value' => variable_get('kandy_excluded_users', ''),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  return $form;
}

/**
 * Kandy Setting Form Submit Action.
 *
 * @param object $form
 *   Form Object.
 * @param string $form_state
 *   Form State.
 */
function kandy_form_submit($form, &$form_state) {
  module_load_include('php', 'kandy', 'kandy_api');
  $setting_attributes = $form_state['values'];
  $old_api_key = variable_get('kandy_api_key', KANDY_API_KEY);
  $old_secret_key = variable_get('kandy_domain_secret_key', KANDY_DOMAIN_SECRET_KEY);
  foreach ($setting_attributes as $key => $value) {
    if ($key == 'kandy_excluded_users') {
      $value = preg_replace('/[^a-zA-Z0-9,\s]/', '', $value);
    }
    variable_set($key, $value);
  }
  $new_api_key = variable_get('kandy_api_key', KANDY_API_KEY);
  $new_secret_key = variable_get('kandy_domain_secret_key', KANDY_DOMAIN_SECRET_KEY);
  if (array_key_exists('kandy_api_key', $setting_attributes) &&
    array_key_exists('kandy_domain_secret_key', $setting_attributes)
  ) {
    if ($old_api_key != $new_api_key || $old_secret_key != $new_secret_key) {
      db_truncate('kandy_users')->execute();
      kandy_sync_users();
    }
  }
  drupal_set_message(t('Save successfully'));
}

/**
 * Get user for search.
 */
function kandy_get_user_for_search() {
  module_load_include('php', 'kandy', 'kandy_api');
  $result = array();
  $query = db_select('users', 'u');
  $query->fields('u', array('uid', 'name'));
  // Change the number of rows with the limit() call.
  $user_results = $query->execute();

  foreach ($user_results as $row) {

    $kandy_user = kandy_get_assign_user($row->uid);
    if ($kandy_user) {
      $kandy_full_name = $kandy_user->user_id . '@' . $kandy_user->domain_name;
      $user_to_add = array(
        'id' => $kandy_full_name,
        'text' => $row->name,
      );
      if (isset($_GET['term'])) {
        $search_string = $_GET['term'];
        if (!empty($search_string) && stripos($user_to_add['text'], $search_string) !== FALSE) {
          array_push($result, $user_to_add);
        }
      }
      else {
        array_push($result, $user_to_add);
      }
    }
  }
  drupal_json_output($result);
}

/**
 * Kandy get name for contact.
 */
function kandy_get_name_for_contact_callback() {
  module_load_include('php', 'kandy', 'kandy_api');
  $contacts = array();
  if (isset($_POST['data'])) {
    $contacts = $_POST['data'];
    foreach ($contacts as &$contact) {
      if (isset($contact['contact_user_name'])) {
        $user = kandy_get_user_by_user_mail($contact['contact_user_name']);
      }
      else {
        $user = kandy_get_user_by_user_mail($contact['full_user_id']);
      }
      if (!empty($user)) {
        if ($user == KANDY_UN_ASSIGN_USER) {
          $display_name = $user;
        }
        else {
          $display_name = $user->name;
        }
      }
      else {
        $display_name = '';
      }
      $contact['display_name'] = $display_name;
    }
  }
  drupal_json_output($contacts);
}

/**
 * Kandy Get Name for chat content ajax.
 */
function kandy_get_name_for_chat_content_callback() {
  module_load_include('php', 'kandy', 'kandy_api');
  if (isset($_POST['data'])) {
    $message = $_POST['data'];
    if (!isset($message['sender'])) {
      return;
    }
    $sender = $message['sender'];
    $display_name = '';
    if (in_array($sender['user_id'], variable_get('kandy_live_chat_users', array()))) {
      $fake_end_time = PHP_INT_MAX;
      $user = db_select('kandy_live_chat', 'lc')
        ->fields('lc', array('customer_name', 'customer_email'))
        ->condition(
          db_and()->condition('customer_user_id', $sender['full_user_id'], '=')
            ->condition('end_at', $fake_end_time, '=')
        )
        ->execute()
        ->fetchObject();
      if ($user) {
        $display_name = $user->customer_name;
        $sender['user_email'] = $user->customer_email;
      }
    }
    else {
      $user = kandy_get_user_by_user_id($sender['user_id']);
      if ($user) {
        $result = user_load($user->main_user_id);
        if ($result) {
          $display_name = $result->name;
        }
      }
    }
    $sender['display_name'] = $display_name;
    $sender['contact_user_name'] = $sender['full_user_id'];
    $message['sender'] = $sender;
  }

  drupal_json_output($message);
}

/**
 * Kandy Get Name for chat content ajax.
 */
function kandy_get_un_assign_user_callback() {
  $result = array();

  module_load_include('php', 'kandy', 'kandy_api');
  if (isset($_GET['current_user']) && isset($_GET['term'])) {
    $kandy_users_unassigned = kandy_list_users(KANDY_USER_UNASSIGNED);
    $result['empty'] = t('None');

    foreach ($kandy_users_unassigned as $kandy_user_item) {
      $user_id = $kandy_user_item->user_id;
      if ($user_id != $_GET['current_user'] && stripos($user_id, $_GET['term']) !== FALSE) {
        $result[$kandy_user_item->user_id] = $kandy_user_item->user_id;
      }
    }
  }

  drupal_json_output($result);
}

/**
 * Implements hook_permission().
 */
function kandy_permission() {
  return array(
    'access kandy content' => array(
      'title' => t('Access content for the kandy module'),
    ),
  );
}

/**
 * KANDY ASSIGNMENT CONFIGURATION PAGE.
 *
 * @return mixed
 *   render style customization page
 */
function kandy_style_customization_page() {
  $module_path = drupal_get_path('module', 'kandy');
  $dir = $module_path . '/css/shortcode';
  $style = 'css';
  $files = file_scan_directory($dir, '/.*\.css$/');
  $form = array();
  $form['label'] = array(
    '#markup' => '<h4>' . t('Select file to edit') . ': </h4>',
  );
  foreach ($files as $file) {
    $file_name = $file->filename;
    $name = $file->name;
    $form[$name . '_link'] = array(
      '#type' => 'link',
      '#title' => $file_name,
      '#href' => url('admin/config/content/kandy/file/edit/' . $style . '/' . $name),
      '#attributes' => array('style' => 'display: block'),
    );
  }

  return $form;
}

/**
 * KANDY ASSIGNMENT CONFIGURATION PAGE.
 *
 * @return mixed
 *   Render script customization page.
 */
function kandy_script_customization_page() {
  $module_path = drupal_get_path('module', 'kandy');
  $dir = $module_path . '/js/shortcode';
  $style = 'js';
  $files = file_scan_directory($dir, '/.*\.' . $style . '$/');
  $form = array();
  $form['label'] = array(
    '#markup' => '<h4>' . t('Select file to edit') . ': </h4>',
  );
  foreach ($files as $file) {
    $file_name = $file->filename;
    $name = $file->name;
    $form[$name . '_link'] = array(
      '#type' => 'link',
      '#title' => $file_name,
      '#href' => 'admin/config/content/kandy/file/edit/$style/$name',
      '#attributes' => array('style' => 'display: block'),
    );
  }
  return $form;
}

/**
 * Kandy User Assignment Form.
 *
 * @return array
 *   Render edit form.
 */
function kandy_file_edit_form($form, &$form_state, $file_style, $file_name) {
  $form = array();
  if ($file_style && $file_name) {
    $public_path = 'public://kandy';
    $file_style = preg_replace('/[^A-Za-z]+/', '-', $file_style);
    $file_name = preg_replace('/[^A-Za-z]+/', '-', $file_name);
    $file_path = t('@public_path/@file_style/@file_name.@file_style', array(
      '@public_path' => $public_path,
      '@file_style' => $file_style,
      '@file_name' => $file_name,
    ));

    if (!file_exists($file_path)) {
      module_load_include('php', 'kandy', 'kandy_api');
      kandy_publish_assets();
    }

    if (file_exists($file_path)) {

      $form['label'] = array(
        '#markup' => '<p>' . t('File: @fileName.@fileStyle', array(
            '@fileName' => $file_name,
            '@fileStyle' => $file_style,
          )) . '</p>',
      );
      $form['content'] = array(
        '#title' => t('Contents'),
        '#type' => 'textarea',
        '#default_value' => file_get_contents($file_path),
        '#rows' => 40,
      );

      $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save'),
      );

      $link_style = ($file_style == 'css') ? 'style' : 'script';
      $return_url = url(
        'admin/config/content/kandy/' . $link_style,
        array('absolute' => TRUE)
      );

      $form['back'] = array(
        '#markup' => '<a href="' . $return_url . '"><input class="form-submit" type="button" value="' . t('Back') . '"/></a>',
      );
    }
    else {
      $markup = '<p>' . t('Not found: @fileName.@fileStyle', array(
          '@fileName' => $file_name,
          '@fileStyle' => $file_style,
        )) . '</p>';
      $form['label'] = array(
        '#markup' => $markup,
      );
      $link_style = ($file_style == 'css') ? 'style' : 'script';
      $return_url = url(
        'admin/config/content/kandy/' . $link_style,
        array('absolute' => TRUE)
      );

      $form['back'] = array(
        '#markup' => '<a   href="' . $return_url . '"><input class="form-submit" type="button" value="' . t('Back') . '"/></a>',
      );
    }

    return $form;

  }
  else {
    drupal_goto('admin/config/content/kandy');
    return array();
  }

}

/**
 * Kandy User Form Submit Action.
 *
 * @param object $form
 *   Form Object.
 * @param string $form_state
 *   Form State.
 */
function kandy_file_edit_form_submit($form, &$form_state) {
  if (isset($form_state['values']['content'])) {
    $public_path = 'public://kandy';
    $file_style = preg_replace('/[^A-Za-z]+/', '-', arg(6));
    $file_name = preg_replace('/[^A-Za-z]+/', '-', arg(7));
    $content = $form_state['values']['content'];

    $file_path = $public_path . DIRECTORY_SEPARATOR . $file_style .
      DIRECTORY_SEPARATOR . $file_name . '.' . $file_style;

    if (file_exists($file_path)) {
      file_put_contents($file_path, $content);
      drupal_set_message(t('Save successfully'));
    }
    else {
      drupal_set_message(t('Some errors with your file. Please try again', 'error'));
    }
  }
  else {
    $form_state['redirect'] = 'admin/config/content/kandy';
  }
}

/**
 * Implements hook_init().
 *
 * Log kandy user out when user logout.
 */
function kandy_init() {
  $just_logout = FALSE;
  if (isset($_COOKIE['Drupal_visitor_kandy_user_logout'])) {
    $just_logout = TRUE;
  }
  if ($just_logout) {
    if (module_exists('kandy')) {

      module_load_include('php', 'kandy', 'kandy_api');
      kandy_logout();
    }
  }
}

/**
 * Implements hook_user_logout().
 *
 * Log user status when user logout.
 */
function kandy_user_logout() {
  module_load_include('php', 'kandy', 'kandy_api');
  global $user;
  user_cookie_save(array('kandy_user_logout' => $user->uid));
  $kandy_user = kandy_get_assign_user($user->uid);
  if ($kandy_user && ($kandy_user->type == KANDY_USER_TYPE_AGENT)) {
    kandy_log_user_login($kandy_user->user_id, KANDY_USER_TYPE_AGENT, KANDY_USER_STATUS_OFFLINE);
  }
}

/**
 * Implements hook_user_login().
 *
 * Log user status when user login.
 */
function kandy_user_login(&$edit, $account) {
  module_load_include('php', 'kandy', 'kandy_api');
  $kandy_user = kandy_get_assign_user($account->uid);
  if ($kandy_user && ($kandy_user->type == KANDY_USER_TYPE_AGENT)) {
    kandy_log_user_login($kandy_user->user_id, KANDY_USER_TYPE_AGENT);
  }
}

/**
 * View agents list function.
 *
 * @param int $user_id
 *   Agent real user id.
 *
 * @return mixed
 *   Return data.
 */
function kandy_view_agent_page($user_id) {
  module_load_include('php', 'kandy', 'kandy_api');
  $header = array(
    array('data' => t('ID')),
    array('data' => t('Rated by')),
    array('data' => t('Rated time')),
    array('data' => t('Score')),
    array('data' => t('Comment')),
  );
  $query = db_select('users', 'u');
  $query->join('kandy_users', 'ku', 'u.uid = ku.main_user_id');
  $info = $query->fields('u', array('name'))
    ->fields('ku', array('user_id'))
    ->condition('u.uid', $user_id, '=')
    ->execute()
    ->fetchObject();
  $rows = kandy_get_agent_progress($user_id);
  drupal_set_title('Agent ' . $info->name . ' ( ' . $info->user_id . ' )');
  $build['pager_table'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('No record found'),
  );
  return $build;
}

/**
 * Agent page function.
 *
 * @return mixed
 *   Return data.
 */
function kandy_chat_agent_page() {
  module_load_include('php', 'kandy', 'kandy_api');
  // We are going to output the results in a table with a nice header.
  $header = array(
    array('data' => t('UID')),
    array('data' => t('Name')),
    array('data' => t('Kandy user')),
    array('data' => t('Average Point')),
    array('data' => t('Actions')),
  );
  $rows = kandy_get_chat_agents();
  $build['add'] = array(
    '#type' => 'link',
    '#title' => t('Add new Agent'),
    '#href' => url(
      'admin/config/content/kandy/livechat/addAgent',
      array(
        'query' => array(
          'returnPath' => 'admin/config/content/kandy/livechat/agent',
        ),
        'absolute' => TRUE,
      )
    ),
  );

  // Create a render array which will be themed as a table with a pager.
  $build['pager_table'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('There are no user found in the db'),
  );

  // Attach the pager theme.
  $build['pager_pager'] = array('#theme' => 'pager');
  return $build;
}

/**
 * Kandy Add agent form.
 *
 * @param object $form
 *   Form Object.
 * @param string $form_state
 *   Form State.
 *
 * @return mixed
 *   Form.
 */
function kandy_agent_form($form, &$form_state) {
  module_load_include('php', 'kandy', 'kandy_api');
  $form['id'] = array(
    '#type' => 'select',
    '#title' => 'Add Agent',
    '#options' => array(0 => 'Select a user') + kandy_get_not_agent(),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Add',
  );
  return $form;
}

/**
 * Agent submit handler.
 *
 * @param mixed $form
 *   Form data.
 * @param array $form_state
 *   Form state.
 */
function kandy_agent_form_submit($form, &$form_state) {
  $form_values = $form_state['values'];
  $row_affected = db_update('kandy_users')
    ->fields(array('type' => KANDY_USER_TYPE_AGENT))
    ->condition('id', $form_values['id'], '=')
    ->execute();
  if ($row_affected) {
    drupal_set_message(t('Add agent successfully'), 'status');
  }
  else {
    drupal_set_message(t('Cannot add chat agent'), 'error');
  }
  drupal_goto(url('admin/config/content/kandy/livechat/agent'));
}

/**
 * Remove user from chat agents list (change type to KANDY_USER_TYPE_NORMAL).
 *
 * @param string $id
 *   User id to be removed.
 */
function kandy_remove_agent($id) {
  $row_affected = db_update('kandy_users')
    ->fields(array('type' => KANDY_USER_TYPE_NORMAL))
    ->condition('id', $id, '=')
    ->execute();
  if ($row_affected) {
    drupal_set_message(t('Remove agent successfully'), 'status');
  }
  else {
    drupal_set_message(t('Cannot remove chat agent'), 'error');
  }
  drupal_goto(url('admin/config/content/kandy/livechat/agent'));
}

/**
 * Display form for add live chat users from kandy excluded list.
 *
 * @param mixed $form
 *   Form data.
 * @param array $form_state
 *   Form state.
 *
 * @return mixed
 *   Return form page.
 */
function kandy_user_form($form, &$form_state) {
  $excluded_users = variable_get('kandy_excluded_users', "");
  $excluded_users = preg_split('/[\s,]+/', $excluded_users);
  $excluded_users = array_combine($excluded_users, $excluded_users);
  $default_values = variable_get('kandy_live_chat_users', array());
  $form['kandy_user_id'] = array(
    '#type' => 'select',
    '#options' => $excluded_users,
    '#multiple' => TRUE,
    '#default_value' => $default_values,
    '#size' => 5,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Save',
  );
  return $form;
}

/**
 * Add live chat user submit handler.
 *
 * @param mixed $form
 *   Form data.
 * @param array $form_state
 *   Form state.
 */
function kandy_user_form_submit($form, &$form_state) {
  $form_values = $form_state['values'];
  $users_id = $form_values['kandy_user_id'];
  array_walk($users_id, 'trim');
  variable_set('kandy_live_chat_users', $users_id);
}

/**
 * Guest register callback for livechat.
 */
function kandy_register_guest_callback() {
  if (!drupal_session_started()) {
    drupal_session_start();
  }
  if (isset($_POST) && !empty($_POST)) {
    $username = $_POST['customerName'];
    $user_email = $_POST['customerEmail'];
    // Save user info to database.
    $user_info = array(
      'username' => $username,
      'email' => $user_email,
    );
    $errors = [];
    if (!$user_email || !valid_email_address($user_email)) {
      $errors['customerEmail'] = t('Please provide a valid email');
    }
    if (!$username) {
      $errors['customerName'] = t('Please enter your name');
    }
    if (empty($errors)) {
      $_SESSION['kandyLiveChatUserInfo'] = $user_info;
      drupal_json_output($user_info);
    }
    else {
      drupal_json_output(array('errors' => $errors));
    }
  }

}

/**
 * Get available kandy user for livechat.
 */
function kandy_get_free_user_callback() {
  module_load_include('php', 'kandy', 'kandy_api');
  if (!drupal_session_started()) {
    drupal_session_start();
  }
  $fake_end_time = PHP_INT_MAX;
  $live_chat_session = $_SESSION['kandyLiveChatUserInfo'];
  $kandy_live_chat_users = variable_get('kandy_live_chat_users', array(''));
  if (isset($live_chat_session['user'])) {
    $query = db_select('kandy_users', 'ku');
    $query->fields('ku')
      ->addExpression('CONCAT(ku.user_id,\'@\', ku.domain_name)', 'full_user_id');
    $query->condition('user_id', $live_chat_session['user']);
    $user = $query->execute()->fetchObject();
  }
  else {
    $query = db_select('kandy_users', 'ku');
    $query->leftJoin('kandy_live_chat', 'lc', 'ku.user_id = lc.customer_user_id');
    $query->leftJoin('kandy_user_login', 'ul', 'ku.user_id = ul.kandy_user_id');
    $query->fields('ku', array('user_id', 'password'));
    $query->addExpression('MAX(end_at)', 'last_end_chat');
    $query->addExpression('CONCAT(ku.user_id, \'@\', ku.domain_name)', 'full_user_id');
    $query->addField('ul', 'time', 'last_active');
    $query->condition('ku.user_id', $kandy_live_chat_users, 'IN');
    $query->havingCondition(db_or()->condition('last_end_chat', $fake_end_time, '<')->isNull('last_end_chat'));
    $query->groupBy('ku.user_id');
    $query->orderBy('last_end_chat');
    $user = $query->execute()->fetchObject();
    if ($user) {
      $live_chat_session['user'] = $user->user_id;
    }
  }
  if (isset($live_chat_session['agent'])) {
    $query = db_select('kandy_users', 'ku');
    $query->join('users', 'u', 'ku.main_user_id = u.uid');
    $query->fields('ku', array(
        'user_id',
        'main_user_id',
        'password',
      )
    );
    $query->fields('u', array('name'));
    $query->addExpression('CONCAT(user_id,\'@\',domain_name)', 'full_user_id');
    $query->condition('user_id', $live_chat_session['agent'], '=');
    $agent = $query->execute()->fetchObject();
  }
  else {
    $query = db_select('kandy_users', 'ku');
    $query->leftJoin('kandy_live_chat', 'lc', 'ku.user_id = lc.agent_user_id');
    $query->leftJoin('users', 'u', 'ku.main_user_id = u.uid');
    $query->fields('ku', array('user_id',
      'password',
      'main_user_id',
    ));
    $query->fields('u', array('name'));
    $query->addExpression('CONCAT(user_id,\'@\', domain_name)', 'full_user_id');
    $query->addExpression('MAX(lc.end_at)', 'last_end_chat');
    $query->condition('ku.type', KANDY_USER_TYPE_AGENT, '=');
    $query->groupBy('u.uid');
    $query->havingCondition(db_or()->condition('last_end_chat', $fake_end_time, '<')->isNull('last_end_chat'));
    $query->orderBy('last_end_chat');
    $agents = $query->execute()->fetchAll();
    $agent = NULL;
    $agent_ids = [];
    if ($agents) {
      foreach ($agents as $key => $item) {
        array_push($agent_ids, $item->full_user_id);
      }
      $last_seen = kandy_get_last_seen($agent_ids);
      if ($last_seen->message == 'success') {
        $last_seen_users = $last_seen->result->users;
        foreach ($last_seen_users as $key => $u) {
          if (($last_active = $last_seen->result->server_timestamp - $u->last_seen) && $last_active < 10000) {
            $agent = $agents[$key];
          }
          else {
            continue;
          }
        }
      }
      if ($agent) {
        $live_chat_session['agent'] = $agent->user_id;
      }
    }
  }
  if ($user && $agent) {
    $now = time();
    kandy_log_user_login($user->user_id, KANDY_USER_TYPE_END_USER);
    $last_id = db_insert('kandy_live_chat')->fields(
      array(
        'agent_user_id' => $agent->user_id,
        'customer_user_id' => $user->full_user_id,
        'customer_name' => $live_chat_session['username'],
        'customer_email' => $live_chat_session['email'],
        'begin_at' => $now,
        'end_at' => $fake_end_time,
      )
    )->execute();
    // Save last insert id.
    $live_chat_session['sessionId'] = $last_id;
    $_SESSION['kandyLiveChatUserInfo'] = $live_chat_session;
    $result = array(
      'status' => 'success',
      'user' => $user,
      'agent' => $agent,
      'apiKey' => variable_get('kandy_api_key', KANDY_API_KEY),
    );
  }
  else {
    // Clean inactive user status
    $query = db_select('kandy_user_login', 'ul');
    $query->fields('ul', array('kandy_user_id'));
    $query->addExpression('UNIX_TIMESTAMP() - time', 'last_active');
    $query->havingCondition('last_active', 60, '>');
    $inactive_users = $query->execute()->fetchCol();
    if (!empty($inactive_users)) {
      $now = time();
      db_update('kandy_live_chat')
        ->fields(array('end_at' => $now))
        ->condition('agent_user_id', $inactive_users, 'IN')
        ->condition('end_at', $fake_end_time, '=')
        ->execute();
    }
    $result = array('status' => 'fail');
  }
  drupal_json_output($result);
}

/**
 * End livechat session callback.
 */
function kandy_end_chat_session_callback() {
  if (!drupal_session_started()) {
    drupal_session_start();
  }
  if (isset($_SESSION['kandyLiveChatUserInfo']) &&
    ($chat_session_info = $_SESSION['kandyLiveChatUserInfo'])
  ) {
    $current_session = intval($chat_session_info['sessionId']);
    // Save end session time.
    db_update('kandy_live_chat')
      ->fields(array('end_at' => time()))
      ->condition('id', $current_session, '=')
      ->execute();
    // Delete session.
    unset($_SESSION['kandyLiveChatUserInfo']);
  }
  drupal_json_output(array(
    'status' => 'success',
  ));
}

/**
 * Rate for livechat agent callback.
 */
function kandy_rate_agent_callback() {
  if (!drupal_session_started()) {
    drupal_session_start();
  }
  $rate = $_POST['rate'];
  $user_id = $_POST['agent_id'];
  $point = $rate['point'] ?: 5;
  $comment = check_plain($_POST['comment']);
  if (!isset($_SESSION['kandyLiveChatUserInfo'])) {
    drupal_json_output(array(
      'success' => FALSE,
      'message' => 'not allowed',
    ));
  }
  else {
    $live_chat_session_info = $_SESSION['kandyLiveChatUserInfo'];
    if (!$user_id) {
      $result = array(
        'success' => FALSE,
        'message' => 'agent is not specified',
      );
    }
    else {
      $now = time();
      db_insert('kandy_live_chat_rate')
        ->fields(array(
          'main_user_id' => $user_id,
          'rated_time' => $now,
          'point' => $point,
          'rated_by' => $live_chat_session_info['email'],
          'comment' => $comment,
        ))
        ->execute();
      $live_chat_session_info['rated'] = TRUE;
      $_SESSION['kandyLiveChatUserInfo'] = $live_chat_session_info;
      $result = array('success' => TRUE);
    }
    drupal_json_output($result);
  }
}

/**
 * Update login status callback.
 */
function kandy_update_login_status_callback() {
  module_load_include('php', 'kandy', 'kandy_api');
  global $user;
  $kandy_user = NULL;
  if ($user->uid) {
    $kandy_user = kandy_get_assign_user($user->uid);
  }
  elseif (isset($_SESSION['kandyLiveChatUserInfo']['user'])) {
    $kandy_user_id = $_SESSION['kandyLiveChatUserInfo']['user'];
    $kandy_user = kandy_get_user_by_user_id($kandy_user_id);
  }
  if ($kandy_user) {
    db_update('kandy_user_login')
      ->fields(array('time' => time()))
      ->condition('kandy_user_id', $kandy_user->user_id, '=')
      ->execute();
  }
}

/**
 * Get user presence status callback.
 */
function kandy_get_presence_status_callback() {
  $server_timestamp = isset($_POST['server_timestamp']) ? $_POST['server_timestamp'] : time();
  $users = isset($_POST['users']) ? $_POST['users'] : array();
  module_load_include('php', 'kandy', 'kandy_api');
  foreach ($users as &$user) {
    $last_active = $server_timestamp - $user['last_seen'];
    if ($last_active > 10000) {
      $user['presence_status'] = 'Offline';
    }
    else {
      $user_id = explode('@', $user['full_user_id']);
      $user_data = kandy_get_user_by_user_id($user_id[0]);
      $user['presence_status'] = ($user_data->presence_status) ? ucfirst(str_replace('-', ' ', $user_data->presence_status)) : 'Available';
    }
    $user['last_active_in'] = $last_active;
  }
  echo json_encode($users);
  exit;
}

/**
 * Set user presence status callback.
 *
 * @param string $presence_status
 *   Presence status.
 */
function kandy_set_presence_status_callback($presence_status) {
  global $user;
  module_load_include('php', 'kandy', 'kandy_api');
  $presence_status = check_plain($presence_status);
  $available_statuses = array(
    'available',
    'away',
    'out-to-lunch',
    'be-right-back',
    'on-vacation',
    'busy',
    'unavailable',
  );
  if (!in_array($presence_status, $available_statuses)) {
    exit;
  }
  $kandy_user = kandy_get_assign_user($user->uid);
  if ($kandy_user) {
    db_update('kandy_users')
      ->fields(array('presence_status' => $presence_status))
      ->condition('user_id', $kandy_user->user_id, '=')
      ->execute();
    echo json_encode(array(
      'status' => 'success',
      'presence_status' => $presence_status,
    ));
    exit;
  }
  echo json_encode(array('status' => 'fail'));
  exit;
}

/**
 * Implements hook_libraries_info().
 *
 * For defining external libraries.
 */
function kandy_libraries_info() {
  $libraries['rateit'] = array(
    'name' => 'RateIt',
    'vendor url' => 'https://rateit.codeplex.com',
    'download url' => 'https://rateit.codeplex.com/downloads/get/169043',
    'version arguments' => array(
      'file' => 'jquery.rateit.min.js',
      'pattern' => '/Version (\d+)/',
      'lines' => 5,
    ),
    'version callback' => 'kandy_rateit_version',
    'files' => array(
      'js' => array('src/jquery.rateit.min.js'),
      'css' => array('src/rateit.css'),
    ),
  );

  return $libraries;
}

/**
 * Ignore rateit library version.
 *
 * @return bool
 *   Return true to ignore library version.
 */
function kandy_rateit_version() {
  return TRUE;
}
